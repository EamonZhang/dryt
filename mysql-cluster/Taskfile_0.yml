version: "3"

tasks:
  default:
    desc: Deploy MySQL Cluster and bind it
    cmds:
      - task: mysql-create
      - task: mysql-wait-ready
      - task: mysql-bind

  mysql-create:
    desc: Create a MySQL database
    cmds:
      - echo "Creating MySQL database {{.NAME}}..."
      - drycc-test resources create {{.NAME}}  mysql-cluster {{.PLAN}} -f mysql-cluster/values.yml -a {{.APP}}

  mysql-wait-ready:
    desc: Wait the MySQL database Ready
    cmds:
      - echo "Waiting for MySQL database to be ready {{.NAME}}..."
      - |
        start=$(date +%s)

        while true; do
          status=$(drycc-test resources describe {{.NAME}} -a {{.APP}} | grep Status | awk '{print $2}')
          elapsed=$(( $(date +%s) - start ))
          
          if [ "$status" = "Ready" ]; then
            printf "\r\033[K ✅ MySQL {{.NAME}} 就绪 (耗时: %ds)\n" "$elapsed"
            break
          fi
          
          printf "\r\033[K ⏳ [%3ds] MySQL {{.NAME}} 状态: %s" "$elapsed" "$status"
          sleep 5
        done

  mysql-bind:
    desc: "Bind the MySQL database resources "
    cmds:
      - echo "Binding MySQL database {{.NAME}}..."
      - |
        drycc-test resources bind {{.NAME}} -a {{.APP}} && sleep 5
      - |
        drycc-test resources describe {{.NAME}} -a {{.APP}} |
        awk '/Data:/{flag=1; next} /^[^ ]/{flag=0} flag && /^[[:space:]]/{
        gsub(/^[[:space:]]+|[[:space:]]+$/, "");
        split($0, a, /:[[:space:]]*/);
        print a[1] "=" a[2]
        }' >> mysql-binding-{{.NAME}}.txt
    generates:
      - mysql-binding-{{.NAME}}.txt
